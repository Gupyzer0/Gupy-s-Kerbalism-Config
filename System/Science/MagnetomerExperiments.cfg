// ============================================================================
// Magnetometer Experiments
// ============================================================================

// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------
@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
		Spacelines_Magnetometer
		{
			ECCost = 0.05	
			size = 1.125 						
			value = 5						
			SetupMass =
			SetupCost =			
			duration = 2700 
			UnlockTech = 
			requirements =
			ResourceRates =
			CrewRequirement =
		}
		Spacelines_MagneticFluxAnalysis
		{
			ECCost = 0.05	
			size = 63						
			value = 7						
			SetupMass =
			SetupCost =			
			duration = 86400 // 1 day 
			UnlockTech = science4
			requirements =
			ResourceRates =
			CrewRequirement =
		}
		Spacelines_MagneticFieldMapping
		{
			ECCost = 0.05	
			size = 810 						
			value = 9						
			SetupMass =
			SetupCost =			
			duration = 8640000 // 100 days 
			UnlockTech = science6
			requirements =
			ResourceRates =
			CrewRequirement =
		}
		Spacelines_LongTermMagneticFieldAnalysis
		{
			ECCost = 0.075	
			size = 3834 						
			value = 16						
			SetupMass =
			SetupCost =			
			duration = 43200000 // 500 days
			UnlockTech = science8
			requirements =
			ResourceRates =
			CrewRequirement =
		}
	}
}

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------
EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_Magnetometer //compatibility - gets switched to DMagic if DMagic is installed.
	title = Magnetometer Scan
	
	scienceCap = 5
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/size$
	@dataScale /= #$baseValue$

	RESULTS
    {
        default = An accurate reading of the local magnetic field is recorded.
     	default = Local variations in the magnetic field are detected.
    }

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = NoBiome
		VirtualBiome = InnerBelt
		VirtualBiome = OuterBelt
		VirtualBiome = Magnetosphere
		VirtualBiome = Storm
		VirtualBiome = Interstellar
		
		Situation = Space@VirtualBiomes
		Situation = Surface@Biomes
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_MagneticFluxAnalysis
	title = Magnetic Flux Analysis
	
	scienceCap = 7
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/size$
	@dataScale /= #$baseValue$
	
	RESULTS	
	{
		default = Magnetic flux through the detector is logged as it orbits, giving further detail in the intricacies of the magnetic field.
		default = Why did they have to make the right-hand rule so hard! All we want to know is which way the field is pointing...
	}

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = NoBiome
		VirtualBiome = InnerBelt
		VirtualBiome = OuterBelt
		VirtualBiome = Magnetosphere
		VirtualBiome = Interstellar
		
		Situation = Space@VirtualBiomes
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_MagneticFieldMapping
	title = Magnetic Field Mapping

	scienceCap = 9
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/size$
	@dataScale /= #$baseValue$
	
	
	RESULTS	
	{
		default = A detailed map of the magnetic field is produced using the data.
	}

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = Magnetosphere
		VirtualBiome = Interstellar
		
		Situation = Space@VirtualBiomes
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_LongTermMagneticFieldAnalysis
	title = Long-Term Magnetic Field Analysis

	scienceCap = 16
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/size$
	@dataScale /= #$baseValue$
	
	RESULTS	
	{
		default = A long-term survey reveals how the planetary magnetic field interacts with the solar wind across a variety of different conditions
	}

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = Magnetosphere
		VirtualBiome = Interstellar
		
		Situation = Space@VirtualBiomes
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------
// Modules being replaced:
// -----------------------
// + bd_magScan
// + magnetometer
// + magScan
// ----------------------------------------------------------------------------

// Tagging all magnetometer parts
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_magScan]]]:NEEDS[FeatureScience] {
    %Tag_magnetometer = True
}
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]]]:NEEDS[FeatureScience] {
    %Tag_magnetometer = True
}
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magScan]]]:NEEDS[FeatureScience] {
    %Tag_magnetometer = True
}

// Creating configure module for all tagged parts
@PART[*]:HAS[#Tag_magnetometer]:NEEDS[FeatureScience] {
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_Magnetometer
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_MagneticFluxAnalysis
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_MagneticFieldMapping
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_LongTermMagneticFieldAnalysis
	}
    
    MODULE
	{
		name = Configure
		title = Magnetometer Experiments
		slots = 1

		SETUP
		{
			name = Magnetometer Scan
			desc = Installs a simple fluxgate magnetometer to record the strength of magnetic fields around the spacecraft. 
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_Magnetometer
			}
		}
		SETUP
		{
			name = Magnetic Flux Analysis
			desc = Installs an improved magnetometer to record the changes in magnetic strength as the spacecraft moves throughout the magnetic field
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_MagneticFluxAnalysis
			}
		}		
		SETUP
		{
			name = Magnetic Field Mapping
			desc = Installs an advanced helium magnetometer to take accurate measurements of the entire magnetic field over time, to help get a more detailed view of its overall structure.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_MagneticFieldMapping
			}
		}	
		SETUP
		{
			name = Long-Term Magnetic Field Analysis
			desc = Installs an advanced helium magnetometer to take accurate measurements of the entire magnetic field over time, to help get a more detailed view of its overall structure.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_LongTermMagneticFieldAnalysis
			}
		}				
	}
}

// Experiments values
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Magnetometer?Experiments]]]:NEEDS[FeatureScience]
{
	@MODULE[Configure]:HAS[#title[Magnetometer?Experiments]]
	{
		@SETUP:HAS[#name[Magnetometer?Scan]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/UnlockTech
		}
		@SETUP:HAS[#name[Magnetic?Flux?Analysis]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/UnlockTech
		}
		@SETUP:HAS[#name[Magnetic?Field?Mapping]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/UnlockTech
		}
		@SETUP:HAS[#name[Long-Term?Magnetic?Field?Analysis]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/UnlockTech
		}
		Spacelines_Magnetometer
		Spacelines_MagneticFluxAnalysis
		Spacelines_MagneticFieldMapping
		Spacelines_LongTermMagneticFieldAnalysis
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_Magnetometer]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/ResourceRates$

		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Magnetometer/size$
	}
	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_MagneticFluxAnalysis]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/ResourceRates$

		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFluxAnalysis/size$
	}
	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_MagneticFieldMapping]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/ResourceRates$

		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_MagneticFieldMapping/size$
	}
	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_LongTermMagneticFieldAnalysis]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/ResourceRates$

		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermMagneticFieldAnalysis/size$
	}
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Magnetometer?Experiment]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment]
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

// ----------------------------------------------------------------------------
// Cleaning old science modules
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_magScan]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[bd_magScan]] {}
}
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]] {}
}
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magScan]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[magScan]] {}
}
