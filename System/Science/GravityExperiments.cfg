// ============================================================================
// Gravity Experiments
// ============================================================================

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------
EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_OrbitalPerturbationsPassive
	title = Orbital Perturbation Studies (Passive) // Using Ground Based Equipment
	baseValue = 35
	scienceCap = 35
	dataScale = 0
	
	RESULTS	
	{
		default = It seems like this planet's mass isn't uniformly distributed, and that
		default = Silly Jool! Stop messing with our orbit from so far away, you little prankster!
	}

    KERBALISM_EXPERIMENT
	{
		Situation = InSpaceLow@Biomes
		BodyAllowed = HomeBody
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_OrbitalPerturbationsActive
	title = Orbital Perturbation Studies // Active Methods
	baseValue = 35
	scienceCap = 35
	dataScale = 1
	
	RESULTS	
	{
		default = It seems like this planet's mass isn't uniformly distributed, and that
		default = Silly Jool! Stop messing with our orbit from so far away, you little prankster!
	}

    KERBALISM_EXPERIMENT
	{
		Situation = InSpaceLow@Biomes
		BodyAllowed = HomeBody
		include = Spacelines_OrbitalPerturbationsPassive
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_GravityScan
	title = Orbital Perturbation Studies - Gravity Scanner
	baseValue = 150
	scienceCap = 150
	dataScale = 250
	
	RESULTS	
	{
		default = It seems like this planet's mass isn't uniformly distributed, and that
		default = Silly Jool! Stop messing with our orbit from so far away, you little prankster!
	}

    KERBALISM_EXPERIMENT
	{
		Situation = InSpaceHigh@Biomes
		Situation = InSpaceLow@Biomes
		include = Spacelines_OrbitalPerturbationsActive
	}
}

// ----------------------------------------------------------------------------
// Tagging parts for experiments
// ----------------------------------------------------------------------------

// Active Methods, use EC (Flashing beacon, Doppler Shift)
@PART[bluedog_Transit2A,bluedog_Transit4A,bluedog_ANNA]:NEEDS[FeatureScience] {
	%Spacelines_GravityActive = True
}

// Passive Methods, don't use EC (Visual tracking without beacons, Laser from ground stations)
@PART[bluedog_Beacon1,bluedog_Explorer_Beacon_SLR,_Knes_Sat_Starlette]:NEEDS[FeatureScience] {
	%Spacelines_GravityPassive = True
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------
// Modules being replaced:
// -----------------------
// + gravityScan
// + Geodesy (Knes)
// ----------------------------------------------------------------------------
@PART[*]:HAS[#experimentID[Spacelines_GravityPassive]]:NEEDS[FeatureScience] {
    MODULE
    {
        name = Experiment
        experiment_id = Spacelines_OrbitalPerturbationsPassive
    }

	!MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]] {}
	!MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]] {}
}

@PART[*]:HAS[#experimentID[Spacelines_GravityActive]]:NEEDS[FeatureScience] {
    MODULE
    {
        name = Experiment
        experiment_id = Spacelines_OrbitalPerturbationsActive
    }

	!MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]] {}
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]]]:NEEDS[FeatureScience] {
    MODULE
    {
        name = Experiment
        experiment_id = Spacelines_GravityScan
    }
}

// ----------------------------------------------------------------------------
// Reconfiguration
// ----------------------------------------------------------------------------
@PART[*]:HAS[@MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbationsPassive]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbationsPassive]] {
		%ec_rate = 0
		%data_rate = 1
		@data_rate /= 6480000 // 75 days
		%requires = OrbitMinInclination:50,OrbitMaxInclination:130,TrackingStationLevelMin:2
		%resources = 
		%hide_when_unavailable = true
    }
}

@PART[*]:HAS[@MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbationsActive]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbationsActive]] {
		%ec_rate = 0.02
		%data_rate = 1
		@data_rate /= 3024000 // 35 days
		%requires = OrbitMinInclination:50,OrbitMaxInclination:130,TrackingStationLevelMin:2
		%resources = 
		%hide_when_unavailable = true
    }
}

@PART[*]:HAS[@MODULE[Experiment]:HAS[#experiment_id[Spacelines_GravityScan]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_GravityScan]] {
		%ec_rate = 0.02
		%data_rate = 75000
		@data_rate /= 25920000 // 300 days
		%requires = OrbitMinInclination:50,OrbitMaxInclination:130
		%resources = 
		%hide_when_unavailable = true
    }
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------
// If there's an experiment with a DMOS module take their animations and insert them
// into the previously created Experiment module
// ----------------------------------------------------------------------------
@PART[*]:HAS[@MODULE[*ModuleScienceAnimate*]:HAS[#experimentID[gravityScan]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_GravityScan]&~anim_deploy[*]&~anim_loop[*]] {
        &anim_deploy = #$../MODULE[*ModuleScienceAnimate*]:HAS[#experimentID[gravityScan]]/animationName$
    }
}

// ----------------------------------------------------------------------------
// Cleaning replaced experiments
// ----------------------------------------------------------------------------
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]] {}
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]] {}
}
