// ============================================================================
// Gravity Experiments
// ============================================================================

// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------

@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
		Spacelines_OrbitalPerturbations
		{
			ECCost = 0.075	
			size = 75000
			value = 250			
			SetupMass =
			SetupCost =			
			duration = 43200000 // 500 days
			UnlockTech = 
			requirements = OrbitMinInclination:50,OrbitMaxInclination:130,TrackingStationLevelMin:2,OrbitMaxEccentricity:0.04
			ResourceRates =
			CrewRequirement = 
		}

		Spacelines_GravityScan
		{
			ECCost = 0.075
			size = 1620 						
			value = 11
			duration = 1944000 	
			SetupMass =
			SetupCost =
			UnlockTech = 
			requirements =
			ResourceRates =
			CrewRequirement = 
		}
	}
}

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------
EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_OrbitalPerturbations
	title = Orbital Perturbation Studies
	
	scienceCap = 35
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/size$
	@dataScale /= #$baseValue$
	
	RESULTS	
	{
		default = It seems like this planet's mass isn't uniformly distributed, and that
		default = Silly Jool! Stop messing with our orbit from so far away, you little prankster!
	}

    KERBALISM_EXPERIMENT
	{
		Situation = InSpaceLow@Biomes
		BodyAllowed = HomeBody
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_GravityScan
	title = Orbital Perturbation Studies - Gravity Scanner
	
	scienceCap = 150
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/size$
	@dataScale /= #$baseValue$
	
	RESULTS	
	{
		default = It seems like this planet's mass isn't uniformly distributed, and that
		default = Silly Jool! Stop messing with our orbit from so far away, you little prankster!
	}

    KERBALISM_EXPERIMENT
	{
		Situation = InSpaceHigh@Biomes
		Situation = InSpaceLow@Biomes
		include = Spacelines_OrbitalPerturbations
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------
// Modules being replaced:
// -----------------------
// + gravityScan
// + Geodesy (Knes)
// ----------------------------------------------------------------------------

// Tagging parts

// Active Methods, use EC (Flashing beacon, Doppler Shift)
@PART[bluedog_Transit2A,bluedog_Transit4A,bluedog_ANNA]:NEEDS[FeatureScience] {
	%Spacelines_GravityActive = True
}

// Passive Methods, don't use EC (Visual tracking without beacons, Laser from ground stations)
@PART[bluedog_Beacon1,bluedog_Explorer_Beacon_SLR]:NEEDS[FeatureScience] {
	%Spacelines_GravityPassive = True
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]]]:NEEDS[FeatureScience]
{
	%Spacelines_GravityPassive = True
}

// Gravity Scan
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]]]:NEEDS[FeatureScience]
{
	%Spacelines_GravityScan = True
}

// Creating Experiment modules

@PART[*]:HAS[#Spacelines_GravityPassive[True]]:NEEDS[FeatureScience] {
	MODULE
    {
        name = Experiment
        experiment_id = Spacelines_OrbitalPerturbations
    }
}

@PART[*]:HAS[#Spacelines_GravityActive[True]]:NEEDS[FeatureScience] {
	MODULE
    {
        name = Experiment
        experiment_id = Spacelines_OrbitalPerturbations
    }
}

@PART[*]:HAS[#Spacelines_GravityScan[True]]:NEEDS[FeatureScience] {
	MODULE
    {
        name = Experiment
        experiment_id = Spacelines_GravityScan
    }
}

// Setting Experiment Values

@PART[*]:HAS[#Spacelines_GravityPassive[True]]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbations]] {
		%ec_rate = 0 // NO EC NEEDED FOR PASSIVE ONES
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/ResourceRates$
		
		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/size$
		
    }
}

@PART[*]:HAS[#Spacelines_GravityActive[True]]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_OrbitalPerturbations]] {
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/ResourceRates$
		
		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_OrbitalPerturbations/size$
    }
}

@PART[*]:HAS[#Spacelines_GravityScan[True]]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_GravityScan]] {
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_GravityScan/ResourceRates$
		
		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SK_GravityExperiments/Spacelines_GravityScan/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SK_GravityExperiments/Spacelines_GravityScan/size$
    }
}


// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------
@PART[*]:HAS[@MODULE:HAS[#Spacelines_GravityPassive[True]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment],*
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

@PART[*]:HAS[@MODULE:HAS[#Spacelines_GravityActive[True]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment],*
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

@PART[*]:HAS[@MODULE:HAS[#Spacelines_GravityScan[True]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment],*
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}


// ----------------------------------------------------------------------------
// Cleaning replaced experiments
// ----------------------------------------------------------------------------
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]]]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[gravityScan]] {}
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]]]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[Geodesy]] {}
}
