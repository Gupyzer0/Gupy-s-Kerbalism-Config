// ============================================================================
// Atmospheric Experiments
// ============================================================================
// Modules being replaced:
// -----------------------
// + bd_hydrometer
// ----------------------------------------------------------------------------

// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------

@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
        Spacelines_LongTermWeatherSurvey
        {
            ECCost = 0.05
			size = 15000
			value = 300				
			SetupMass =
			SetupCost =			
			duration = 36814180 
			UnlockTech = science7
			requirements = Part:sensorThermometer,Part:sensorBarometer 
			ResourceRates =
			CrewRequirement = 
        }

		// Crew required experiments
		Spacelines_CURVE										//Flying High, 1 Hour, no biomes.
		{
			ECCost = 31.8							
			size = 1627
			value = 21								// high value, can only be done once per body.
			duration = 1892							// 30-ish min
			SetupMass = 0.005
			SetupCost = 8250
			UnlockTech = aerodynamics5
			requirements = MissionControlLevelMin:2,AstronautComplexLevelMin:2,AltitudeMin:45000
			CrewRequirement = Pilot:2
			ResourceRates = 			
		}

		Spacelines_WING										//Flying Low, biomes. reasonably short.
		{
			ECCost = 2.8							
			size = 38
			value = 11								// Low value due to biomes.
			duration = 627							// 10-ish minutes 
			SetupMass = 0.025
			SetupCost = 2375
			UnlockTech = aviation3
			requirements = AltitudeMax:6000
			CrewRequirement = Pilot:1
			ResourceRates = 			
		}

		Spacelines_CLOUD //Flying High, Biomes. 20m or so. Due to duration + biomes, will probably need multiple passes per biome.
		{
			ECCost = 5.13							
			size = 185
			value = 12								// meh value due to biomes, but more than WING due to high atmo and duration.
			duration = 1200							// 20m
			SetupMass = 0.015
			SetupCost = 3290
			UnlockTech = aviation4
			requirements =
			CrewRequirement = Pilot:3
			ResourceRates = 			
		}
    }
}

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_LongTermWeatherSurvey
	title = Atmospheric Sample
	
	scienceCap = 250
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
	@dataScale /= #$baseValue$

	RESULTS
    {
        default = You measure the composition of the atmosphere.
    }

    KERBALISM_EXPERIMENT
	{
        VirtualBiome = NorthernHemisphere
		VirtualBiome = SouthernHemisphere
	
		Situation = Surface@VirtualBiomes
		
		BodyAllowed = Atmospheric
		BodyNotAllowed = HomeBody
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_CURVE
	title = CURVE
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/size$
	@dataScale /= #$baseValue$
	scienceCap = 22
	
  	KERBALISM_EXPERIMENT
	{
   		Situation = FlyingHigh
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_WING
	title = WING
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/size$
	@dataScale /= #$baseValue$
	scienceCap = 16
  
  	KERBALISM_EXPERIMENT
	{
    	Situation = FlyingLow@Biomes
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_CLOUD
	title = CLOUD
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/size$
	@dataScale /= #$baseValue$
	scienceCap = 40
  
  	KERBALISM_EXPERIMENT
	{
    	Situation = FlyingHigh@Biomes
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------

// Tagging all atmospheric experiments parts
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_hydrometer]]]:NEEDS[FeatureScience] {
    %Tag_SpacelinesAtmosphericExperiments = True
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]]]:NEEDS[FeatureScience] {
    %Tag_SpacelinesAtmosphericExperiments = True
}

// Creating configure module for all tagged parts
@PART[*]:HAS[#Tag_SpacelinesAtmosphericExperiments]:NEEDS[FeatureScience] {
    MODULE
	{
		name = Experiment
		experiment_id = atmosphereAnalysis
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_LongTermWeatherSurvey
	}
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_CURVE
	}		
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_WING
	}
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_CLOUD
	}
    
    MODULE
	{
		name = Configure
		title = Atmospheric Science
		slots = 1

		UPGRADES
		{
			UPGRADE
			{
				name__ = Atmo-Upgrade1
				techRequired__ = aviation3
				slots = 2
			}
		}

		SETUP
		{
			name = Atmospheric Analysis
			desc = Installs a suite of basic automated experiments to allow for in-situ research on alien atmospheres.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = atmosphereAnalysis
			}
		}
		SETUP
		{
			name = Long-Term Weather Survey
			desc = Installs a suite of instruments to allow for a long term surface analysis of a planet's weather conditions. Requires a thermometer and barometer present on the craft to help with collecting weather readings.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_LongTermWeatherSurvey
			}
		}
		SETUP
		{
			name = CURVE
			desc = Checking Undulating Radial Vectors of Environment: Ensuring the planet is still round from the upper atmosphere.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_CURVE
			}
		}
		SETUP
		{
			name = WING
			desc = Wandering Investigation Not on the Ground: Not many takers to watch the ground zipping past so quickly!
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_WING
			}
		}
		SETUP
		{
			name = CLOUD
			desc = Cumulative Longitudinal Overland Understanding of Dynamic: "Dynamic what?", many Kerbals ask.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_CLOUD
			}
		}
    }
}

// Experiments values
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]]]:NEEDS[FeatureScience]
{
	@MODULE[Configure]:HAS[#title[Atmospheric?Science]]
	{
		@SETUP:HAS[#name[Atmospheric?Analysis]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/UnlockTech
		}
        @SETUP:HAS[#name[Long-Term?Weather?Survey]]
		{
			cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/SetupCost
            mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/SetupMass
            tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/UnlockTech
		}
		@SETUP:HAS[#name[CURVE]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/SetupCost$
		}
		@SETUP:HAS[#name[WING]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/SetupCost$
		}
		@SETUP:HAS[#name[CLOUD]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/SetupCost$
		}
	}

	@MODULE[Experiment]:HAS[#experiment_id[atmosphereAnalysis]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/ResourceRates$
		
		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/STOCK/atmosphereAnalysis/size$
	}

    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_LongTermWeatherSurvey]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/ResourceRates$
		
		%experimentLength = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/duration$
		%experimentSize = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_CURVE]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CURVE/ResourceRates$
		%allow_shrouded = False
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_WING]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_WING/ResourceRates$
		%allow_shrouded = False
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_CLOUD]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_CLOUD/ResourceRates$
		%allow_shrouded = False
	}
}

//removing stock experiments to avoid duplicates. they get added through SETUPs, unlocked at stock tech.
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]],!MODULE[Experiment]:HAS[#experiment_id[barometerScan]]]:NEEDS[FeatureScience]
{
	!MODULE[Experiment]:HAS[#experiment_id[barometerScan]]		{}
	
	MODULE
	{
		name = Experiment
		experiment_id = barometerScan
	}		
}

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]],!MODULE[Experiment]:HAS[#experiment_id[atmosphereAnalysis]]]:NEEDS[FeatureScience]
{
//removing stock experiments to avoid duplicates. they get added through SETUPs, unlocked at stock tech.
	!MODULE[Experiment]:HAS[#experiment_id[atmosphereAnalysis]]	{}		

	MODULE
	{
		name = Experiment
		experiment_id = atmosphereAnalysis
	}
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment]
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

// ----------------------------------------------------------------------------
// Cleaning old science modules
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_hydrometer]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[bd_hydrometer]] {}
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]] {}
}
