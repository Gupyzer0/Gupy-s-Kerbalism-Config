// ============================================================================
// Micrometeorites Experiments
// ============================================================================

// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------

@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
		Spacelines_Micrometeorites{
			ECCost = 0.05
			size = 1.5				
			value = 5
			duration = 3600
			requirements = 
			ResourceRates = 
			CrewRequirement = 
		}

		Spacelines_LargeSurfaceAreaMicrometeorites{
			ECCost = 0.05
			size = 7500				
			value = 280
			duration = 17280000 // 200 days
			requirements = 
			ResourceRates = 
			CrewRequirement = 
		}
	}
}

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_Micrometeorites
	title = Micrometeoroid Impact Data
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Micrometeorites/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_Micrometeorites/size$
	@dataScale /= #$baseValue$
	scienceCap = 5
	requireAtmosphere = False
	situationMask = 48 // in space low, in space high
	biomeMask = 0

	RESULTS
	{
		default = All's quiet. Looks like nothing's going t- PING!
		default = There might have been an impact recently, but you weren't paying attention.
		default = The hole beside the impactor COULD be a test result but you're too busy stopping explosive decompression to find out.
    }

    KERBALISM_EXPERIMENT 
	{
		Situation = InSpaceLow
		Situation = InSpaceHigh
	}
}

EXPERIMENT_DEFINITION:NEEDS[FeatureScience]
{
	id = Spacelines_LargeSurfaceAreaMicrometeorites
	title = Large Surface Area Micrometeoroid Impact Detector
	baseValue = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/value$
	dataScale = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/size$
	@dataScale /= #$baseValue$
	scienceCap = 280
	requireAtmosphere = False
	situationMask = 48 // in space low, in space high
	biomeMask = 0

	RESULTS
	{
		default = The instrument records impacts to estimate the density of micrometeorites at specific altitudes.
		default = You register several small micrometeorite collisions in a span of minutes. Perhaps you passed through some sort of debris field. 
		default = Woah! That last micrometeorite nearly punched through the detector! Perhaps we need thicker panels on future spacecraft.
	}

    KERBALISM_EXPERIMENT 
	{
		Situation = InSpaceLow
		Situation = InSpaceHigh
		BodyAllowed = HomeBodyandMoons
        IncludeExperiment = Spacelines_Micrometeorites
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------
// Modules being replaced:
// -----------------------
// + logmmImpacts -> Spacelines_Micrometeorites
// + bd_pegasus -> Spacelines_LargeSurfaceAreaMicrometeorites
// ----------------------------------------------------------------------------

// Tagging all parts
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[logmmImpacts]]]:NEEDS[FeatureScience] {
    %Tag_Spacelines_Micrometeorites = True
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_pegasus]]]:NEEDS[FeatureScience] {
	%Tag_Spacelines_LargeSurfaceAreaMicrometeorites = True
}

// Experiment module
@PART[*]:HAS[#Tag_Spacelines_Micrometeorites[True]]:NEEDS[FeatureScience] {
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_Micrometeorites
	}
}

@PART[*]:HAS[#Tag_Spacelines_LargeSurfaceAreaMicrometeorites[True]]:NEEDS[FeatureScience] {
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_LargeSurfaceAreaMicrometeorites
	}
}

// Setting Experiment Values
@PART[*]:HAS[#Tag_Spacelines_Micrometeorites[True]]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_Micrometeorites]] {
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/ECCost$
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/ResourceRates$

		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_Micrometeorites/size$
	}
}

@PART[*]:HAS[#Tag_Spacelines_LargeSurfaceAreaMicrometeorites[True]]:NEEDS[FeatureScience] {
    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_LargeSurfaceAreaMicrometeorites]] {
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/ECCost$
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/ResourceRates$

		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LargeSurfaceAreaMicrometeorites/size$
	}
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------

@PART[*]:HAS[#Tag_Spacelines_Micrometeorites[True]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment],*
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

@PART[*]:HAS[#Tag_Spacelines_LargeSurfaceAreaMicrometeorites[True]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment],*
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

// ----------------------------------------------------------------------------
// Cleaning old science modules
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[logmmImpacts]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
  !MODULE[*ModuleScience*]:HAS[#experimentID[logmmImpacts]] {}
}
@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[bd_pegasus]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
  !MODULE[*ModuleScience*]:HAS[#experimentID[bd_pegasus]] {}
}
