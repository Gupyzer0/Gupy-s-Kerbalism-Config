// ============================================================================
// Patching all parts that have a Laboratory Module.
// ============================================================================
// adding the experiments, patching the SETUPs and the experiment parameters 
// based on values from the relevant config in the tweakables folder.

// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------
// Lab exclusive experiments (with the exception of goo and matbay).
// tried to cover most situations (landed, orbital, underwater, flying)
// makes the labs have a purpose again.
// I preffer for the labs to require scientists at varying levels present at all times to do the experiments.
// high ec requirements are appropriate imo, adds a requirement to design stuff properly.
@KERBALISM_GROUP_SETTINGS:NEEDS[FeatureScience]
{
	LAB_EXPERIMENTS
	{
		BaseSlots = 1
		UpgradeTech = spaceStations8
		UpgradedSlots = 2
		UpgradeEntryCost = 35000
		ReconfigureTech = fieldScience				//lab has a upgrade that allows reconfiguration in the field. these 2 handle the requirements for that to happen
		ReconfigureRequirement = Scientist:5
		ReconfigureEntryCost = 65000
		LabDataRateMultiplier = 2					// Duration reduction for labs.
		LabECMultiplier = 5							// EC Cost multiplier
		LabSampleReservoirMultiplier = 2			// for experiments that have sampling reservoirs.

		// General experiments
		JAMMED								//Low orbit only, no biomes, 18 months.
		{
			ECCost = 1.28
			size = 9942
			value = 30								// high-ish value due to being available once per orbital body.
			duration = 5832000						// 9 months ingame. due to Shadow requirement, it'll take double. No cheesing because orbit.
			SetupMass = 2.74
			SetupCost = 25720
			UnlockTech = spaceStations6
			requirements = Shadow	//let's see how shadow works.
			CrewRequirement = True
			ResourceRates = 						//no clue, because idk what the experiment is in the first place
		}
		
		// Biome investigation while flying
		BIRDIE								//Atmospheric experiment, flying high/low, Flying low biomes. have fun carrying a lab around. I'll also allow kerbin
		{
			ECCost = 1.42
			size = 58
			value = 14								// starting value.
			duration = 1800							// 30 min, otherwise it's too grindy
			SetupMass = 0.38
			SetupCost = 17830
			UnlockTech = spaceStations6
			requirements =
			CrewRequirement = Scientist:1
		}

		// Underwater lab experiments
		SALINE										//4 months, underwater, biomes. I'll allow kerbin
		{
			ECCost = 6.32
			size = 6490
			value = 27								// starting value.
			duration = 2592000						// 4 months
			SetupMass = 1.35
			SetupCost = 7440
			UnlockTech = spaceStations6
			requirements = AltitudeMax:-50 	//diving!
			CrewRequirement = Scientist:4
		}

		// Plant growth experiment
		CHILLED										//plant growth, 200-ish days (same as a greenhouse cycle. both orbital and landed, no biomes.
		{
			ECCost = 4.62
			size = 22568
			value = 24								// No biomes, thus fairly high value.
			duration = 4320000						// 200 days
			SetupMass = 3.55
			SetupCost = 12800
			UnlockTech = spaceStations7
			requirements = Greenhouse
			CrewRequirement = Scientist
			ResourceRates = 						// cba to do math. will fix later
		}

		// Geological research -> requires shelters
		RELAX										//3 month geological research, landed, biomes, i'll allow kerbin.
		{
			ECCost = 10.92
			size = 14928
			value = 28								// lower value due to biomes
			duration = 2052000						// 90-ish days
			SetupMass = 5.27
			SetupCost = 16300
			UnlockTech = bases9
			requirements =
			CrewRequirement = Scientist:2
			ResourceRates = Ore@0.001				// makes sense?
		}

		// Advanced General Studies - General Studies, Kind off an endgame Lab Experiment -> yields 4000 science per year.
        Spacelines_GeneralStudies
        {
            ECCost = 25
            size = 460177250
            value = 200000
            duration = 788923800 // Roughly 25 years
            SetupMass = 0.05
            SetupCost = 20000
            UnlockTech = SpaceStations8
            requirements = AstronautComplexLevelMin:3
            CrewRequirement = Scientist
            ResourceRates = 
        }
	}
}

// ----------------------------------------------------------------------------
// Kerbalism Config
// ----------------------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_JAMMED]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/size$
	@dataScale /= #$baseValue$

  	KERBALISM_EXPERIMENT
	{
		Situation = InSpaceLow
		BodyNotAllowed = Suns
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_BIRDIE]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/size$
	@dataScale /= #$baseValue$
  
  	KERBALISM_EXPERIMENT
	{
		Situation = FlyingLow@Biomes
		Situation = FlyingHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_SALINE]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/size$
	@dataScale /= #$baseValue$

  	KERBALISM_EXPERIMENT
	{
		Situation = SrfSplashed@Biomes
		SampleMass = 103.68
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_CHILLED]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/size$
	@dataScale /= #$baseValue$
  
  	KERBALISM_EXPERIMENT
	{
		Situation = SrfLanded
		Situation = SrfSplashed
		Situation = InSpaceLow
		BodyNotAllowed = HomeBody
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_RELAX]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/size$
	@dataScale /= #$baseValue$

  	KERBALISM_EXPERIMENT
	{
		Situation = SrfLanded@Biomes
		SampleMass = 2052
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_GeneralStudies]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/value$
	@dataScale = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/size$
	@dataScale /= #$baseValue$

  	KERBALISM_EXPERIMENT
	{
		Situation = Space
	}
}

// Adding the relevant experiment modules
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]],!MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]]:NEEDS[FeatureScience]
{
//removing stock experiments to avoid duplicates. they get added through SETUPs, unlocked at stock tech.
	!MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]	{}

	MODULE
	{
		name = Experiment
		experiment_id = mobileMaterialsLab
	}
}

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]],!MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]]:NEEDS[FeatureScience]
{
//removing stock experiments to avoid duplicates. they get added through SETUPs, unlocked at stock tech.
	!MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]{}

	MODULE
	{
		name = Experiment
		experiment_id = mysteryGoo
	}
}

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	// SpaceStations6
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_JAMMED
	}
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_BIRDIE
	}
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_SALINE
	}

	// SpaceStations7
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_CHILLED
	}

	// SpaceStations8
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_GeneralStudies
	}
	
	// Bases9
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_RELAX
	}

	// Bases11
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_COLODEMO
	}

	// ------------------------------------------------------------------------
	// Adding the Configure module to handle the experiment selection, together
	// with the corresponding setups.
	// ------------------------------------------------------------------------
	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		SETUP
		{
			name = None
			desc = Empty slot for mass and cost savings, should you not require any experiments installed.
		}
		SETUP
		{
			name = Materials Bay Study
			desc = Install a SC-9001 Science Jr. Materials Bay in the Laboratory, allowing on-board scientists to study the behaviour of "materials" in different environments.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = mobileMaterialsLab
			}
		}
		SETUP
		{
			name = Mystery Goo Observation
			desc = Install a Mystery Goo Containment Unit in the Laboratory, allowing on-board scientists to study the behaviour of the Goo in different environments.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = mysteryGoo
			}
		}
		SETUP
		{
			name = JAMMED
			desc = Justified Analysis of Meticulous Mindfulness while Extruding Data: Basically just early general scientific research.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_JAMMED
			}
		}
		SETUP
		{
			name = BIRDIE
			desc = Biome Investigation Retconning Deep Investigations at Elevation: Analyzing biomes from high above, but not space high of course.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_BIRDIE
			}
		}
		SETUP
		{
			name = SALINE
			desc = Sea Alkalinity Longterm Investigation to Neutralise Environment: Overly salted Kerbal Scientists investigate ways to neutralise the water.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_SALINE
			}
		}
		SETUP
		{
			name = CHILLED
			desc = Chlorophyl Horticulture In Lived Laboratory Experimental Determinations:  Scientists will spend time watching grass grow for science.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_CHILLED
			}
		}
		SETUP
		{
			name = AEDGE
			desc = Advanced General Studies: Got an experiment to do in microgravity? we can doit for you with this module.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_GeneralStudies
			}
		}
		SETUP
		{
			name = RELAX
			desc = Regolith Experiential Laboratory Analysis eXplanation:  Scientists will spend time developing a meaningful relationship with the local regolith.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_RELAX
			}
		}
	}
}
// ============================================================================
// the experiments were just added above, but not configured. This section takes care of that

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@MODULE[Configure]:HAS[#title[Laboratory?Experiments]]
	{
		%slots = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BaseSlots$
		%reconfigure = false

		UPGRADES
		{
			UPGRADE
			{
				name__ = Lab-Upgrade1
				techRequired__ = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/UpgradeTech$
				slots = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/UpgradedSlots$
			}
			UPGRADE
			{
				name__ = Lab-Upgrade2
				techRequired__ = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/ReconfigureTech$
				reconfigure = #$../../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/ReconfigureRequirement$
			}
		}

		@SETUP:HAS[#name[Materials?Bay?Study]]
		{
			%tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mobileMaterialsLab/UnlockTech$
			%mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mobileMaterialsLab/SetupMass$
			%cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mobileMaterialsLab/SetupCost$
		}

		@SETUP:HAS[#name[Mystery?Goo?Observation]]
		{
			%tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mysteryGoo/UnlockTech$
			%mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mysteryGoo/SetupMass$
			%cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mysteryGoo/SetupCost$
		}

		@SETUP:HAS[#name[JAMMED]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/SetupCost$
		}

		@SETUP:HAS[#name[BIRDIE]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/SetupCost$
		}

		@SETUP:HAS[#name[SALINE]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/SetupCost$
		}

		@SETUP:HAS[#name[CHILLED]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/SetupCost$
		}

		@SETUP:HAS[#name[AEDGE]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/SetupCost$
		}

		@SETUP:HAS[#name[RELAX]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/SetupCost$
		}

		@SETUP:HAS[#name[COLODEMO]]
		{
			%tech = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_COLODEMO/UnlockTech$
			%mass = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_COLODEMO/SetupMass$
			%cost = #$../../@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_COLODEMO/SetupCost$
		}
	}

	@MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]
	{
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mobileMaterialsLab/CrewRequirement$
	}

	@MODULE[Experiment]:HAS[#experiment_id[mysteryGoo]]
	{
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/mysteryGoo/CrewRequirement$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_JAMMED]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/duration$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/JAMMED/ResourceRates$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_BIRDIE]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/BIRDIE/duration$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_SALINE]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/duration$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
		// %resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/SALINE/ResourceRates$
		%sample_collecting = True
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_CHILLED]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/duration$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/CHILLED/ResourceRates$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_GeneralStudies]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/Spacelines_GeneralStudies/duration$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_RELAX]]
	{
		%ec_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/ECCost$
		%crew_operate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/CrewRequirement$
		%requires = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/requirements$
		%data_rate = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/size$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/duration$
		@data_rate /= #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/LabDataRateMultiplier$
		%resources = #$@KERBALISM_GROUP_SETTINGS/LAB_EXPERIMENTS/RELAX/ResourceRates$
		%sample_collecting = True
	}
}
