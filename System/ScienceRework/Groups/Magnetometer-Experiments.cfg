// ============================================================================
// Magnetometer Experiments
// ============================================================================
// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------
@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
		magScan
		{
			ECCost = 0.2
			size = 2.6
			value = 5
			duration = 151200 // 7 days
		}

		Spacelines_HeliumMagnetometer
		{
			ECCost = 0.05	
			size = 40
			value = 6
			SetupMass =
			SetupCost =			
			duration = 1296000 // 15 days
			UnlockTech = science4
			requirements =
			ResourceRates =
			CrewRequirement =
		}
		Spacelines_FluxgateMagnetometer
		{
			ECCost = 0.05	
			size = 115 						
			value = 20
			SetupMass =
			SetupCost =			
			duration = 3888000 // 45 days 
			UnlockTech = science6
			requirements =
			ResourceRates =
			CrewRequirement =
		}
	}
}

// ----------------------------------------------------------------------------
// Kerbalism Config
// ----------------------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[magScan]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/size$
	@dataScale /= #$baseValue$

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = NoBiome
		VirtualBiome = InnerBelt
		VirtualBiome = OuterBelt
		VirtualBiome = Magnetosphere
		VirtualBiome = Storm
		
		Situation = InSpaceLow@VirtualBiomes
		Situation = InSpaceHigh@VirtualBiomes
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_HeliumMagnetometer]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/size$
	@dataScale /= #$baseValue$

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = NoBiome
		VirtualBiome = InnerBelt
		VirtualBiome = OuterBelt
		VirtualBiome = Magnetosphere
		VirtualBiome = Storm
		
		Situation = InSpaceLow@VirtualBiomes
		Situation = InSpaceHigh@VirtualBiomes
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_FluxgateMagnetometer]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/size$
	@dataScale /= #$baseValue$

    KERBALISM_EXPERIMENT
	{
		VirtualBiome = NoBiome
		VirtualBiome = InnerBelt
		VirtualBiome = OuterBelt
		VirtualBiome = Magnetosphere
		VirtualBiome = Storm
		
		Situation = InSpaceLow@VirtualBiomes
		Situation = InSpaceHigh@VirtualBiomes
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------

// Tagging all magnetometer parts

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]]]:NEEDS[FeatureScience] {
    %Tag_magScan = True
}

// Creating configure module for all tagged parts
@PART[*]:HAS[#Tag_magScan[True]]:NEEDS[FeatureScience] {
    MODULE
	{
		name = Experiment
		experiment_id = magScan
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_HeliumMagnetometer
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_FluxgateMagnetometer
	}
    
    MODULE
	{
		name = Configure
		title = Magnetometer Experiments
		slots = 1

		SETUP
		{
			name = Magnetometer Scan
			desc = Installs a simple magnetometer to record the strength of magnetic fields around the spacecraft. 
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = magScan
			}
		}
		SETUP
		{
			name = Helium Magnetometer
			desc = Helium magnetometer on flown on Mariner 4 and many other missions
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_HeliumMagnetometer
			}
		}		
		SETUP
		{
			name = Fluxgate Magnetometer
			desc = Fluxgate Magnetometer Boom on Voyager and Galileo
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_FluxgateMagnetometer
			}
		}	
	}
}

// Experiments values
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Magnetometer?Experiments]]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@MODULE[Configure]:HAS[#title[Magnetometer?Experiments]]
	{
		@SETUP:HAS[#name[Magnetometer?Scan]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/UnlockTech
		}
		@SETUP:HAS[#name[Helium?Magnetometer]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/UnlockTech
		}
		@SETUP:HAS[#name[Fluxgate?Magnetometer]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/UnlockTech
		}
	}

	@MODULE[Experiment]:HAS[#experiment_id[magScan]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/duration$

		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/magScan/size$
	}
	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_HeliumMagnetometer]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/ECCost$
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/ResourceRates$

		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_HeliumMagnetometer/size$
	}
	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_FluxgateMagnetometer]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/ECCost$
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/ResourceRates$

		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_FluxgateMagnetometer/size$
	}
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Magnetometer?Experiment]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment]
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}

// ----------------------------------------------------------------------------
// Cleaning old science modules
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]]]:AFTER[zzzKerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[magnetometer]] {}
}
