// STOCK EXPERIMENTS

@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	STOCK
	{
		crewReport
		{
			ECCost = 0.01 							// the light must be on...
			size = 0.2
			value = 3								//nerfed science value slightly, due to another longer crewed experiment being available (5->3), removed atmospheric biome mask.
			duration = 294
			requirements =
			ResourceRates =
		}

		evaReport
		{
			ECCost = 0.02
			size = 0.25
			value = 10								//slightly increased value (8->10)
			duration = 45	// removed atmospheric situatons (i'm sorry but astronauts don't EVA inside an atmosphere)
			requirements =
			ResourceRates =
		}
    
    	// KSP 1.11 golf playing
		evaScience
		{
			size = 0.25
			value = 10								//nerfed value (25->10)
		}

		surfaceSample
		{
			ECCost = 	
			size = 512 						
			value = 50								
			duration = 10
			SetupMass =
			SetupCost =
			UnlockTech = 
			requirements = AstronautComplexLevelMin:2
			ResourceRates =
			CrewRequirement =
		}

		asteroidSample								//the only change that takes effect is size and value
		{
			size = 1694								// long lab analysis for the sample.
			value = 35								// biome should be irrelevant, asteroids don't have biomes, and flying above a planet's biome should also be irrelevant for the sample.
		}

		cometSample_short
		{
			size = 1694
			value = 100
		}
    
    	cometSample_intermediate
		{
			size = 1694
			value = 150
		}
    
    	cometSample_long
		{
			size = 1694
			value = 300
		}
    
    	cometSample_interstellar
		{
			size = 1694
			value = 1000
		}
	}
}

// ----------------------------------------------------------------------------
// Science Definitions 
// ----------------------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[surfaceSample]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = SrfLanded@Biomes
    SampleMass = 0.025
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[crewReport]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = FlyingLow
    Situation = FlyingHigh
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[evaReport]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    Situation = Surface@Biomes
    Situation = InSpaceLow
    Situation = InSpaceHigh
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[evaScience]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaScience/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaScience/size$
	@dataScale /= #$baseValue$
}

// note : we use the stock ModuleAsteroid experiment that we patch at runtime, the sample mass
// is defined globally in settings.cfg
@EXPERIMENT_DEFINITION:HAS[#id[asteroidSample]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/asteroidSample/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/asteroidSample/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[cometSample_short]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_short/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_short/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[cometSample_intermediate]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_intermediate/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_intermediate/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[cometSample_long]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_long/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_long/size$
	@dataScale /= #$baseValue$
}

@EXPERIMENT_DEFINITION:HAS[#id[cometSample_interstellar]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_interstellar/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/cometSample_interstellar/size$
	@dataScale /= #$baseValue$
}

// ============================================================================
// Replacing stock experiments with our own, one by one.
// Affects all parts that use both the stock module AND stock experiments.
// ============================================================================

@PART[kerbalEVA*]:HAS[@MODULE[ModuleTripLogger]]:NEEDS[FeatureScience]
{
	!MODULE:HAS[#experimentID[surfaceSample]]	{}
	!MODULE:HAS[#experimentID[evaReport]]		{}
	MODULE
	{
		name = Experiment
		experiment_id = surfaceSample
	}
	MODULE
	{
		name = Experiment
		experiment_id = evaReport
	}
}
@PART[*]:HAS[@MODULE:HAS[#experimentID[crewReport]]]:NEEDS[FeatureScience]
{
	!MODULE:HAS[#experimentID[crewReport]]	{}
	MODULE
	{
		name = Experiment
		experiment_id = crewReport
	}
}
// Replace the stock scanner module with our experiment that reproduce the feature
// Do it late (zzz) in case some MM patch is relying on that module being present (ScanSat ?)
// @PART[*]:HAS[@MODULE[ModuleOrbitalSurveyor]]:NEEDS[FeatureScience]:FOR[zzzKerbalismDefault]
// {
//   !MODULE[ModuleOrbitalSurveyor] {}

//   MODULE
//   {
//     name = Experiment
//     experiment_id = KerbalismResourceScanner
//     experiment_desc = #$@KERBALISM_GROUP_SETTINGS/ORBITAL_EXPERIMENTS/ResourceScanner/desc$
//     data_rate = #$@KERBALISM_GROUP_SETTINGS/ORBITAL_EXPERIMENTS/ResourceScanner/size$
//     @data_rate /= #$@KERBALISM_GROUP_SETTINGS/ORBITAL_EXPERIMENTS/ResourceScanner/duration$
//     ec_rate = #$@KERBALISM_GROUP_SETTINGS/ORBITAL_EXPERIMENTS/ResourceScanner/ECCost$
//     requires = #$@KERBALISM_GROUP_SETTINGS/ORBITAL_EXPERIMENTS/ResourceScanner/requirements$
//     allow_shrouded = false
//   }
// }

// ============================================================================
// Reconfigure stock experiments(avoiding a global nuke to keep people happy)
// strongly recommendeded to not change anything in this section
// Separate from above due to Configure Groups.
// ============================================================================
@PART[*]:HAS[@MODULE[Experiment]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@MODULE[Experiment]:HAS[#experiment_id[crewReport]]
	{
		%experiment_description = A brief situation report of dubious relevance and accuracy.
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/ECCost$
		%crew_operate = True
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/crewReport/ResourceRates$
	}

	@MODULE[Experiment]:HAS[#experiment_id[surfaceSample]]
	{
		%sample_collecting = True
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/requirements$
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/ResourceRates$
		%hide_when_unavailable = true
	}

	@MODULE[Experiment]:HAS[#experiment_id[evaReport]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/ECCost$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/duration$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/requirements$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/evaReport/ResourceRates$
		%crew_operate = True
	}	
}

// ============================================================================
// Animation fix for goo container & materials bay
// ============================================================================
@PART[GooExperiment,science_module,Magnetometer]:NEEDS[FeatureScience]:AFTER[KerbalismDefault]
{
	!MODULE[ModuleAnimateGeneric] {}
  	!MODULE[ModuleDeployablePart] {}
	@MODULE[Experiment]
	{
		%anim_deploy = Deploy
	}
}
// ============================================================================
// Nerfing EC cost for EVA kerbals for surface sample, otherwise it's unuseable
// Done this way because of groups that include the surface sample.
// ============================================================================
@PART[kerbalEVA*]:HAS[@MODULE[ModuleTripLogger]]:NEEDS[FeatureScience]:AFTER[KerbalismDefault]
{
	@MODULE[Experiment]:HAS[#experiment_id[surfaceSample]]
	{
		@ec_rate /= #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/EVAMultiplier$
		@requires = #$@KERBALISM_EXPERIMENT_VALUES/STOCK/surfaceSample/EVArequirements$
	}
}

// ============================================================================
// Remove scientist bonus
// ============================================================================

@EXPERIENCE_TRAIT[Scientist]:NEEDS[FeatureScience]
{
	@desc = Scientists can reset experiments.
	@EFFECT[VesselScienceReturn] { @modifiers = 1, 1, 1, 1, 1 }
	@EFFECT[PartScienceReturn]   { @modifiers = 1, 1, 1, 1, 1 }
}

// ============================================================================
// Lab module satisfies stock contracts
// ============================================================================

@Contracts:NEEDS[FeatureScience]
{
	@Base
	{
		@PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
	}
	@Station
	{
		@PART_REQUEST:HAS[#Module[ModuleScienceLab]] { @Module = Laboratory }
	}
}

// ======================================================================
// adds sensors to gravioli/radiation/temperature/pressure to all parts that use
// the stock experiments and do not already have one.
// ============================================================================


