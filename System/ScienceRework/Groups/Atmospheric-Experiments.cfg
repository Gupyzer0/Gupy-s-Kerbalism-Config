// ============================================================================
// Atmospheric Experiments
// ============================================================================
// Modules being replaced:
// -----------------------
// + bd_hydrometer
// ----------------------------------------------------------------------------
// Experiment Values
// ----------------------------------------------------------------------------

@KERBALISM_EXPERIMENT_VALUES:NEEDS[FeatureScience]
{
	%SPACELINES
	{
		Spacelines_AtmosphericSampling
		{
			ECCost = 0.05	
			size = 512 						
			value = 17								
			duration = 10 
			SetupMass =
			SetupCost =
			UnlockTech = science6
			requirements =
			ResourceRates =
			CrewRequirement =
		}
		Spacelines_AtmosphereAnalysis
		{
			ECCost = 0.05	
			size = 45 						
			value = 10								
			duration = 108000 // 1 day and a bit more
			SetupMass =
			SetupCost =
			UnlockTech = science7
			requirements =
			ResourceRates =
			CrewRequirement = 
		}
        Spacelines_LongTermWeatherSurvey
        {
            ECCost = 6
			size = 15000
			value = 300				
			SetupMass =
			SetupCost =			
			duration = 36720000 // 425 days 
			UnlockTech = science8
			requirements = Part:sensorThermometer,Part:sensorBarometer 
			ResourceRates =
			CrewRequirement = 
        }
    }
}

// ----------------------------------------------------------------------------
// Kerbalism Config
// ----------------------------------------------------------------------------

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_AtmosphericSampling]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/size$
	@dataScale /= #$baseValue$

	KERBALISM_EXPERIMENT
	{
		SampleMass = 0.0007
	
		Situation = Surface@Biomes
		Situation = FlyingLow
		Situation = FlyingHigh
		
		BodyAllowed = Atmospheric
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_AtmosphereAnalysis]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/size$
	@dataScale /= #$baseValue$

	KERBALISM_EXPERIMENT
	{
		Situation = Surface@Biomes
		Situation = FlyingLow
		Situation = FlyingHigh
		
		BodyAllowed = Atmospheric
	}
}

@EXPERIMENT_DEFINITION:HAS[#id[Spacelines_LongTermWeatherSurvey]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
	@dataScale /= #$baseValue$

	RESULTS
    {
        default = You measure the composition of the atmosphere.
    }

    KERBALISM_EXPERIMENT
	{
        VirtualBiome = NorthernHemisphere
		VirtualBiome = SouthernHemisphere
	
		Situation = Surface@VirtualBiomes
		
		BodyAllowed = Atmospheric
		BodyNotAllowed = HomeBody
	}
}

// ----------------------------------------------------------------------------
// Replacing Experiments with our own experiment
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]]]:NEEDS[FeatureScience] {
    %Tag_SpacelinesAtmosphericExperiments = True
}

// Creating configure module for all tagged parts
@PART[*]:HAS[#Tag_SpacelinesAtmosphericExperiments[True]]:NEEDS[FeatureScience] {
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_AtmosphericSampling
	}
	MODULE
	{
		name = Experiment
		experiment_id = Spacelines_AtmosphereAnalysis
	}
    MODULE
	{
		name = Experiment
		experiment_id = Spacelines_LongTermWeatherSurvey
	}
    
    MODULE
	{
		name = Configure
		title = Atmospheric Science
		slots = 1

		UPGRADES
		{
			UPGRADE
			{
				name__ = Atmo-Upgrade1
				techRequired__ = aviation3
				slots = 2
			}
		}
		SETUP
		{
			name = Atmospheric Sampling
			desc = Installs a system to collect, store, and preserve samples of alien atmospheres for research at a lab.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_AtmosphericSampling
			}
		}

		SETUP
		{
			name = Atmospheric Analysis
			desc = Installs a suite of basic automated experiments to allow for in-situ research on alien atmospheres.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_AtmosphereAnalysis
			}
		}
		SETUP
		{
			name = Long-Term Weather Survey
			desc = Installs a suite of instruments to allow for a long term surface analysis of a planet's weather conditions. Requires a thermometer and barometer present on the craft to help with collecting weather readings.
			MODULE
			{
				type = Experiment
				id_field = experiment_id
				id_value = Spacelines_LongTermWeatherSurvey
			}
		}
    }
}

// Experiments values
@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]]]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	@MODULE[Configure]:HAS[#title[Atmospheric?Science]]
	{
		@SETUP:HAS[#name[Atmospheric?Sampling]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/UnlockTech
		}
		@SETUP:HAS[#name[Atmospheric?Analysis]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/UnlockTech
		}
        @SETUP:HAS[#name[Long-Term?Weather?Survey]]
		{
			cost = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/SetupCost
            mass = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/SetupMass
            tech = #$../../@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/UnlockTech
		}
		
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_AtmosphericSampling]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/ECCost$
		//%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/ResourceRates$
		
		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphericSampling/size$
	}

	@MODULE[Experiment]:HAS[#experiment_id[Spacelines_AtmosphereAnalysis]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/ECCost$
		//%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/ResourceRates$
		
		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_AtmosphereAnalysis/size$
	}

    @MODULE[Experiment]:HAS[#experiment_id[Spacelines_LongTermWeatherSurvey]]
	{
		%ec_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/ECCost$
		%crew_operate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/CrewRequirement$
		%requires = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/requirements$
		%data_rate = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
		@data_rate /= #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/duration$
		%resources = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/ResourceRates$
		
		%experimentLength = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/duration$
		%experimentSize = #$@KERBALISM_EXPERIMENT_VALUES/SPACELINES/Spacelines_LongTermWeatherSurvey/size$
	}
}

// ----------------------------------------------------------------------------
// Animations
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[Configure]:HAS[#title[Atmospheric?Science]],@MODULE:HAS[#animationName]]:NEEDS[FeatureScience]
{
	@MODULE[Experiment]
	{
		%anim_deploy = #$../MODULE:HAS[#animationName,~name[Experiment]]/animationName$
	}
}


//Atmospheric Science Upgrade
PARTUPGRADE:NEEDS[FeatureScience]
{
  name = Atmo-Upgrade1
  partIcon = sensorAtmosphere
  title = Atmospheric Science Slot Upgrade
  manufacturer = A&D Aerospace
  description = Adds an additional experiment slot to all Atmospheric Science groups.
}
@PARTUPGRADE[Atmo-Upgrade1]:NEEDS[FeatureScience]:FOR[KerbalismDefault]
{
	%techRequired = aviation5//#$@KERBALISM_GROUP_SETTINGS/ATMO_EXPERIMENTS/UpgradeTech$
	%entryCost = 8000//#$@KERBALISM_GROUP_SETTINGS/ATMO_EXPERIMENTS/UpgradeEntryCost$
}

// ----------------------------------------------------------------------------
// Cleaning old science modules
// ----------------------------------------------------------------------------

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]]]:FOR[KerbalismDefault]:NEEDS[FeatureScience] {
    !MODULE[*ModuleScience*]:HAS[#experimentID[atmosphereAnalysis]] {}
}
