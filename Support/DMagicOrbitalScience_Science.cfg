// Rewritten from scratch - Gotmachine - 10-2019 :
// Removed the patching hell, things are now ordered
// Restored some experiments to their vanilla module and behavior :
// - ASERT (asteroid experiment with some specific gameplay requirements)
// - Anomalous Signal Sensor (special feature : find anomalies)
// - ExoKerbol Core Drill (surface sample)
// - Surface Ablation Laser Light Imager (surface + asteroid data)
// - Seismic Sensor Pod / Impact Hammer (surface experiment with specific features)
// - XRD Surface Analyzer (surface + asteroid data)
// Rationale : those experiments either have specific constraints or features,
// and most of them make sense as a instant experiments.
// Also, we are missing a way to handle some of their animations and ground surface checks.
// For the patched experiments, major changes compared to previous support :
// - Removed all configurable DMOS experiments that were on the stock scanner
// - the Magnetometer and RPWS antenna now use the custom radiation biomes
// - the Solar Particle Collector is a sample again, with a much higher science value than before
// - Dynamic Albedo of Neutrons surface experiment now require to be moving over the surface (so rover only)
// - The SIGINT and RECON experiments will generate their vanilla north/sud hemisphere subjects
// - These changes should fix most issues we had previously with undoable DMOS contracts
// - Fixed some animations, rebalanced some data sizes and durations
// Size consideration: a mid-game rove mate has 12 MB storage, experiments should more or less fit in there.
// Note : we patch all modules with the DM* wildcard with a matching experimentID in order to target both DMOS
// DMModuleScienceAnimate and other DM modules like the standalone DMModuleScienceAnimateGeneric, in order to
// alos patch parts from other mods that uses the DMOS experiments (US2, COATL ProbesPlus...)

// =========================================================
// DMOS "Probe science" folder
// =========================================================

// =========================================================
// Asteroid Sounding Experiment by Radiowave Transmission - part : dmASERT / module : DMAsteroidScanner / expID : dmAsteroidScan
// =========================================================
// UNPATCHED
// The ASERT is an asteroid-only experiment used to study the interior composition of asteroids.
// It must be paired with a second module placed on the opposite side of an asteroid.
// When two modules are properly positioned the experiment can be conducted with the science amount
// dependent on how much of the asteroid the signal passed through.

@EXPERIMENT_DEFINITION:HAS[#id[dmAsteroidScan]]:NEEDS[DMagicOrbitalScience,FeatureScience]:FOR[zzzKerbalismDefault]
{
	@dataScale = 30 // size in Mb
	@dataScale /= #$baseValue$
}

// =========================================================
// GORESat - part : dmGoreSat - module : DMModuleScienceAnimate
// =========================================================
// The Global Orbital Radiance Experiment Satellite (GORESat) monitors the total light reflected
// from a planet's surface across multiple wavelengths using four cavity radiometers. Can only be used from high orbit.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmRadiometerScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]:FOR[KerbalismDefault]
{
    %Tag_Spacelines_RadarAltimeter = True
}

// =========================================================
// Multi-Spectral Imaging Platform - part : dmImagingPlatform - module : DMModuleScienceAnimate
// =========================================================
// This multi-spectral imaging platform is used to study the surface and composition of planets. Use only in orbit.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmImagingPlatform]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_ImagingSpectrometer = True
}

// =========================================================
// Magnetometer Boom - part : dmmagBoom - module : DMModuleScienceAnimate + DMMagBoomModule
// =========================================================

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[magScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_magnetometer = True
}

// =========================================================
// RPWS Antenna - part : rpwsAnt - module : DMModuleScienceAnimate
// =========================================================
// The Radio and Plasma Wave Science instrument measures electrostatic and electromagnetic fields generated
// by the interaction of planetary magnetospheres and the interplanetary plasma medium.
// Deploy and use while in low to high orbit. Not for use during atmospheric flight or surface deployment.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[rpwsScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_RPWS = True
}

// =========================================================
// Orbital Telescope - part : dmscope - module : DMModuleScienceAnimate
// =========================================================

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[scopeScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_AstronomyExperiments = True
}

// =========================================================
// Soil Moisture Sensor - part : dmSoilMoisture - module : DMSoilMoisture
// =========================================================
// This orbital sensor deploys a large L-band microwave detector comprised of 82 individual antenna elements.
// It can be used to study the water content of the upper soil layers and the salinity levels of large water features.
// Can only be used in low orbit. This instrument can also be used as a powerful communications antenna.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmSoilMoisture]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_SoilMoisture = True
}

// =========================================================
// Solar Particle Collector - part : dmSolarCollector - module : DMSolarCollector
// =========================================================
// This instrument is designed to collect and store several samples of solar particles.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmSolarParticles]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_SolarWind = True
}

// =========================================================
// DMOS "Rover science" folder
// =========================================================

// =========================================================
// Anomalous Signal Sensor - part : dmAnomScanner / module : DMAnomalyScanner / expid : AnomalyScan
// =========================================================
// UNPATCHED : very specific and quite usefull
// This small sensor is designed to scan for anomalous signals across several regions of the electromagnetic spectrum.
// You must be within 250m of the signal to obtain science results; use it from further out to obtain an estimate
// of the range and distance to the signal. For the best results, return the device to the KSC for further study.
// @EXPERIMENT_DEFINITION:HAS[#id[AnomalyScan]]:NEEDS[DMagicOrbitalScience,FeatureScience]:FOR[zzzKerbalismDefault]
// {
// 	@dataScale = 12 // size in Mb
// 	@dataScale /= #$baseValue$

//   KERBALISM_EXPERIMENT
//   {
//     // vanilla DMOS AnomalyScan uses the SrfLanded and FlyingLow situations, we patch them so they are available in the science archive
//     // See https://github.com/DMagic1/Orbital-Science/blob/51cbc3c6def1ed7e02a8bb42f819dac678f61983/Source/Part%20Modules/DMAnomalyScanner.cs#L588
//     IsGeneratingSubjects = true
//     IgnoreBodyRestrictions = true
//     Situation = SrfLanded
//     Situation = FlyingLow
//   }
// }

// =========================================================
// Submersible Oceanography and Bathymetry - part : dmBathymetry - module : DMBathymetry
// =========================================================
// Use this submersible science package to explore the uncharted depths of the oceans.
// Data can be collected above and below the depth threshold to maximize science gain.
@KERBALISM_EXPERIMENT_VALUES:NEEDS[DMagicOrbitalScience,FeatureScience]
{
	%DMagicOrbitalScience
	{
    dmbathymetryscan
    {
			size = 800
			value = 16
			duration = 900	// 15 min.
    }
  }
}

@EXPERIMENT_DEFINITION:HAS[#id[dmbathymetryscan]]:NEEDS[DMagicOrbitalScience,FeatureScience]:FOR[zzzKerbalismDefault]
{
	@baseValue = #$@KERBALISM_EXPERIMENT_VALUES/DMagicOrbitalScience/dmbathymetryscan/value$
	@dataScale = #$@KERBALISM_EXPERIMENT_VALUES/DMagicOrbitalScience/dmbathymetryscan/size$
	@dataScale /= #$baseValue$

  KERBALISM_EXPERIMENT
	{
    SampleMass = 0.02
	}
}

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmbathymetryscan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    @description = Use this submersible science package to explore the uncharted depths of the oceans.

    MODULE
    {
        name = Experiment
        experiment_id = Spacelines_H2O
        %ec_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/ECCost$
        %crew_operate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/CrewRequirement$
        %requires = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/requirements$
        %data_rate = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/size$
        @data_rate /= #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/duration$
        %resources = #$@KERBALISM_GROUP_SETTINGS/SPACELINES/Spacelines_H2O/ResourceRates$
        %sample_collecting = True
        %allow_shrouded = False
    }

    !MODULE:HAS[#experimentID,~name[Experiment]] {}
}

// =========================================================
// ExoKerbol Core Drill - part : dmbioDrill - module : DMBioDrill
// =========================================================
// SEMI-PATCHED : Using the vanilla module because we don't have a surface check and there is no deploy animation
// and anyway we would do it as a very short experiment
// we only add a small drive to store the samples and change the xmitdatascalar to make it a sample
// The ExoKerbol Core Drill (XKCD) is designed to collect subsurface core samples to search for
// signs of biological activity on atmospheric planets. Three drill core samples can be stored
// in the incubation chambers for return. Check drill animator orientation with the preview in the VAB/SPH.

@PART[*]:HAS[@MODULE[DMBioDrill]:HAS[#experimentID[dmbiodrillscan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_CoreSampleDrill = True
}

// =========================================================
// Dynamic Albedo of Neutrons - part : dmDAN - module : DMModuleScienceAnimate
// =========================================================
// NOTE : made this a (short) rover-only experiment by requiring a surface speed > 1.0
// The Dynamic Albedo of Neutrons instrument scans the upper layers of the surface
// to detect any hydrogen molecules within, specifically searching for water. Require moving over the surface to acquire data.

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmNAlbedoScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_XrayDiffractionScan = True
}

// =========================================================
// Surface Ablation Laser Light Imager - part : dmsurfacelaser - module : DMModuleScienceAnimate - expID = dmlaserblastscan
// =========================================================
@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmlaserblastscan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_LaserSurfaceScan = True
}

@PART[*]:HAS[@MODULE[*ModuleScience*]:HAS[#experimentID[dmlaserblastscan]]]:NEEDS[FeatureScience]:FINAL {
    !MODULE[*ModuleScience*]:HAS[#experimentID[dmlaserblastscan]] {}
}

// =========================================================
// SC-901 Science Micro - part : dmRoverMat
// =========================================================
@PART[dmRoverMat]:NEEDS[DMagicOrbitalScience,FeatureScience]:AFTER[KerbalismDefault]
{
	@MODULE[Experiment]:HAS[#experiment_id[mobileMaterialsLab]]
	{
        anim_deploy = MatBay
        anim_loop = MatSample
		@data_rate /= 2
		@UPGRADES
		{
			@UPGRADE[MatBay-Storage-Upgrade]
			{
				%sample_amount = 1
			}
		}
	}
  !MODULE:HAS[#experimentID,~name[Experiment]] {}
}

// =========================================================
// Seismic Sensor Pod / Seismic Impact Hammer (dmSeismicPod/dmSeismicHammer), expid = dmseismicHammer
// =========================================================
@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmSeismicPod]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    -MODULE[DM*] {}

    MODULE
	{
		name = Experiment
		experiment_id = seismicScan
	}
}

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmSeismicHammer]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    -MODULE[DM*] {}
    
    MODULE
	{
		name = Experiment
		experiment_id = seismicScan
	}
}

// =========================================================
// XRD Surface Analyzer - part : dmXRay, module : DMXRayDiffract, expID : dmXRayDiffract
// =========================================================

@PART[*]:HAS[@MODULE[DM*]:HAS[#experimentID[dmXRayDiffract]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_XrayDiffractionScan = True
}

// =========================================================
// DMOS "OversizeScience" folder
// =========================================================

// =========================================================
// Little Brother / Big Brother Surveillance Camera - parts : dmReconSmall/dmReconLarge - module : DMReconScope - expID : dmReconScan
// =========================================================
// This single-camera surveillance telescope features a continuously panning aperture that covers 110 degree bands of the surface.
// This model features two non-reusable film cannisters and has limited on-board processing capabilities.
// Use for obtaining detailed photos of the surface or spotting any unusual features.
// Can be used at up to five times the normal low orbit altitude.

@PART[*]:HAS[@MODULE[DMReconScope]:HAS[#experimentID[dmReconScan]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_Photos4 = True
}

@PART[dmReconSmall|dmReconLarge]:NEEDS[DMagicOrbitalScience,FeatureScience]:AFTER[Spacelines-Kerbalism]
{
    @MODULE:HAS[#experiment_id[Spacelines_Photos4]]
    {
        retractedDragCube = Default
        deployedDragCube = Default
    }
}

// =========================================================
// Undersize/Oversize Signals Intelligence Satellite - parts : dmSIGINT.Small/dmSIGINT.End - module : DMSIGINT - expID : dmSIGINT
// =========================================================
// A mildly oversized radio signals intelligence dish that can be used for listening in to every imaginable from of communication,
// discovering radio anomalies on a planet's surface, or just impressing your neighbor. Warning: Dish is FRAGILE;
// it is NOT for use in the atmosphere; CANNOT be retracted! Can be used at up to five times the normal low orbit altitude.
// This instrument can also be used as a powerful communications antenna.

@PART[*]:HAS[@MODULE[DMSIGINT]:HAS[#experimentID[dmSIGINT]]]:NEEDS[DMagicOrbitalScience,FeatureScience]
{
    %Tag_Spacelines_SIGINT = True
}

@PART[dmSIGINT.Small]:NEEDS[DMagicOrbitalScience,FeatureScience]:AFTER[Spacelines-Kerbalism]
{
    @MODULE:HAS[#experiment_id[Spacelines_SIGINT]]
    {
        retractedDragCube = Clean
        deployedDragCube = Deployed
    }
}

@PART[dmSIGINT.End]:NEEDS[DMagicOrbitalScience,FeatureScience]:AFTER[Spacelines-Kerbalism]
{
  @MODULE:HAS[#experiment_id[Spacelines_SIGINT]]
  {
    retractedDragCube = Clean
    deployedDragCube = Deployed
  }

    @MODULE[ModuleJettison],*
    {
        @allowShroudToggle = True
        @hideJettisonMenu = False
    }
}
